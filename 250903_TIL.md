## TIL - 2025.09.03

### ğŸ” ì˜¤ëŠ˜ ë°°ìš´ ë‚´ìš©
- ì´ë©”ì¼ ì¸ì¦ 
- ë‹¤ì¤‘ Ref ì²˜ë¦¬

---

#### ì´ë©”ì¼ ì¸ì¦
íšŒì›ê°€ì… ì¤‘ ì´ë©”ì¼ ì¸ì¦ ë¡œì§ì„ êµ¬í˜„í•˜ê¸° ìœ„í•´ í•™ìŠµí–ˆë‹¤.   

ì´ë©”ì¼ ì¸ì¦ ê³¼ì •ì€ ì•„ë˜ 3ë‹¨ê³„ë¡œ ë‚˜ëˆŒ ìˆ˜ ìˆë‹¤.   
1. ì„œë²„ì—ì„œ ì¸ì¦ë²ˆí˜¸ ìƒì„±
2. ì„œë²„ì—ì„œ ì´ë©”ì¼ ë°œì†¡ 
3. í´ë¼ì´ì–¸íŠ¸ ì¸ì¦ë²ˆí˜¸ ì…ë ¥   

-  SMTP ìƒì„±   
> SMTPë€?   
Simple Mail Transfer Protocolì˜ ì•½ìë¡œ ì¸í„°ë„·ì„ í†µí•´ ì´ë©”ì¼ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ê³  ë°›ëŠ”ë° ì‚¬ìš©ë˜ëŠ” í†µì‹  í”„ë¡œí† ì½œì´ë‹¤. ë©”ì¼ ì„œë²„ ë° ê¸°íƒ€ ë©”ì„¸ì§€ ì „ì†¡ ì—ì´ì „íŠ¸(MTA)ëŠ” SMTPë¥¼ ì‚¬ìš©í•˜ì—¬ ë©”ì¼ì„ ë³´ë‚´ê³  ë°›ëŠ”ë‹¤.

SMTP í”„ë¡œí† ì½œë¡œ ë©”ì¼ì„ ì£¼ê³ ë°›ì„ SMTP ì„œë²„ëŠ” ë„¤ì´ë²„ ë©”ì¼ì„ ì‚¬ìš©í–ˆê³  ì•„ë˜ ì‚¬ì§„ê³¼ ê°™ì´ ì„¤ì •í–ˆë‹¤.   

1. ì¢Œì¸¡ í•˜ë‹¨ í™˜ê²½ì„¤ì • í´ë¦­ > ì•„ë˜ ì„ íƒëœ í™”ë©´ê³¼ ë™ì¼í•˜ê²Œ ì„ íƒ > ì„¤ì •í•˜ê¸° ëˆŒëŸ¬ì„œ 2ë‹¨ê³„ ì¸ì¦ ì§„í–‰
![alt text](image-26.png)   
2. 2ë‹¨ê³„ ì¸ì¦ ì„ íƒ í›„ ì¸ì¦ ì§„í–‰
![alt text](image-27.png)   
ì–´í”Œë¦¬ì¼€ì´ì…˜ ë¹„ë°€ë²ˆí˜¸ ìƒì„± ì§„í–‰   
ë¹„ë°€ë²ˆí˜¸ ìƒì„±ìœ¼ë¡œ ìƒì„±ëœ ë¹„ë°€ë²ˆí˜¸ëŠ” application.ymlì— ì‘ì„±ë  ë¹„ë°€ë²ˆí˜¸ë¡œ    
ì§„ì§œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  ìƒì„±ëœ ë¹„ë°€ë²ˆí˜¸ë¡œ ë©”ì¼ë°œì†¡ì— ì‚¬ìš©í•œë‹¤.
![alt text](image-28.png)   
3. application.yml ì„¤ì •   
ì•„ë˜ ê³„ì •ì •ë³´ì™€ ì„œë²„ëª…ì„ í™•ì¸í•˜ì—¬ application.ymlì— ì‘ì„±í•œë‹¤.
![alt text](image-29.png)   
spring: ì•„ë˜ì— ì‘ì„±í•˜ë©´ ëœë‹¤.
    ```
    # mail send setting
    mail:
        host: smtp.naver.com
        port: 465
        username: // ì•„ì´ë””
        password: // ìƒì„±í•œ ë¹„ë°€ë²ˆí˜¸
        protocol: smtp
        properties:
        mail:
            smtp:
            auth: true
            ssl:
                enable: true
    ```

- ì¸ì¦ë©”ì¼ ë°œì†¡ ë¡œì§ ì‘ì„±   
1. íšŒì›ê°€ì… ì‹œ ë©”ì¼ì„ ë¨¼ì € ì…ë ¥ë°›ì•„ ì¤‘ë³µì—¬ë¶€ë¥¼ í™•ì¸í•œë‹¤.   
flagê°€ trueë©´ ì¤‘ë³µëœ ì´ë©”ì¼ì´ê³ , falseë©´ ì‚¬ìš©ê°€ëŠ¥í•œ ì´ë©”ì¼ì´ë‹¤.   
api controller ë‹¨ìœ¼ë¡œ true/falseë¡œ ê²°ê³¼ë¥¼ ì „ë‹¬í•œë‹¤.
    ```
    public boolean checkEmailDuplicate(String email) {

            boolean flag = userRepository.existsByEmail(email);
            log.info("email - {} is duplicated: {}", email, flag);

            return flag;
        }
    ```
2. ì¤‘ë³µëœ ë©”ì¼ì´ ì•„ë‹ˆë©´ ì¸ì¦ì½”ë“œë¥¼ ìƒì„±í•œë‹¤.   
    ```
    // ì´ë©”ì¼ ì¸ì¦ ì½”ë“œ ë°œì†¡ ë¡œì§
    private String sendVerificationEmail(String email) {
        // ì¸ì¦ì½”ë“œ ìƒì„±
        return generateCode();
    }

    // ë¬´ì‘ìœ„ë¡œ 10000 ~ 99999 ì‚¬ì´ì˜ ëœë¤ ìˆ«ìë¥¼ ìƒì„±
    private String generateCode() {
        return String.valueOf( (int) (Math.random() * 90000) + 10000);
    }
    ```
    ì¤‘ë³µí™•ì¸ ì½”ë“œë¥¼ ìˆ˜ì •í•˜ì—¬ ì¸ì¦ì½”ë“œê°€ ì œëŒ€ë¡œ ìƒì„±ë˜ëŠ”ì§€ í™•ì¸í•´ë´¤ë‹¤.
    ```
    public boolean checkEmailDuplicate(String email) {
        ...
        if(!flag) {
            String code = sendVerificationEmail(email);
            log.info("verification code: {}", code);
        }
    }
    ```
    5ìë¦¬ ëœë¤ ì½”ë“œê°€ ì˜ ìƒì„±ë˜ê³  ìˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.   
    ![alt text](image-30.png)

3. ë©”ì¼ ë°œì†¡ ë¡œì§ì„ ì‘ì„±í•œë‹¤.   
ë©”ì¼ ë°œì†¡ì„ ìœ„í•´ì„œ ì˜ì¡´ì„±ì„ ì¶”ê°€í•˜ê³  ì˜ì¡´ê°ì²´ì™€ application.ymlì— ì‘ì„±í•œ ë©”ì¼ í˜¸ìŠ¤íŠ¸ ì •ë³´ë„ ê°€ì ¸ì˜¨ë‹¤. 
    ```
    private final JavaMailSender mailSender;

    @Value("${spring.mail.username}")
    private String mailHost;

    dependencies{
        // ì´ë©”ì¼ ì „ì†¡ ë¼ì´ë¸ŒëŸ¬ë¦¬
        implementation 'org.springframework.boot:spring-boot-starter-mail'
    }
    ```
    ë©”ì¼ ì „ì†¡ ë¡œì§ì€ ì•„ë˜ì™€ ê°™ë‹¤. sendVerificationEmail ë©”ì†Œë“œ ì•ˆì— ì¶”ê°€í•œë‹¤.
    ```
    MimeMessage mimeMessage = mailSender.createMimeMessage();

    try {
        MimeMessageHelper messageHelper
                = new MimeMessageHelper(mimeMessage, false, "UTF-8");

        // ëˆ„êµ¬ì—ê²Œ ì´ë©”ì¼ì„ ë³´ë‚¼ì§€
        messageHelper.setTo(email);

        // ëˆ„ê°€ ë³´ë‚´ëŠ” ê±´ì§€
        messageHelper.setFrom(mailHost);

        // ì´ë©”ì¼ ì œëª© ì„¤ì •
        messageHelper.setSubject("[ì¸ì¦ë©”ì¼]");
        // ì´ë©”ì¼ ë‚´ìš© ì„¤ì •
        messageHelper.setText(
                "ì¸ì¦ ì½”ë“œ: <b style=\"font-weight: 700; letter-spacing: 5px; font-size: 30px;\">" + code + "</b>"
                , true
        );

        // ë©”ì¼ ë³´ë‚´ê¸°
        mailSender.send(mimeMessage);

        log.info("{} ë‹˜ì—ê²Œ ì´ë©”ì¼ì´ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.", email);
        return code;

    } catch (Exception e) {
        e.printStackTrace();
        throw new RuntimeException("ë©”ì¼ ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }
    ```
    ë©”ì¼ ì „ì†¡ì€ MimeMessageHelper ë¥¼ ì‚¬ìš©í•´ì„œ ë³´ë‚´ê³  ìˆë‹¤. 

    MimeMessageHelperë€?
    > spring í”„ë ˆì„ì›Œí¬ì—ì„œ ì œê³µí•˜ëŠ” í´ë˜ìŠ¤ë¡œ javax.mail.internet.MimeMessage ê°ì²´ë¥¼ ì¢€ ë” í¸ë¦¬í•˜ê²Œ ë‹¤ë£° ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ëŠ” í´ë˜ìŠ¤ì´ë‹¤.  

    í•´ë‹¹ ì½”ë“œë¥¼ ì‹¤í–‰ì‹œì¼œë³´ë©´    
    ![alt text](image-31.png)    
    ë©”ì¼ ë°œì†¡ë¡œì§ì´ ë™ì‘í•¨ì„ ì•Œìˆ˜ìˆë‹¤.

4. ì„ì‹œíšŒì› ê°€ì… ì¶”ê°€   
ì„ì‹œ íšŒì›ê°€ì…ì€ ì‚¬ìš©ìê°€ íšŒì›ê°€ì… ê³¼ì •ì—ì„œ ë°œìƒí•˜ëŠ” í”¼ë¡œë„ë¥¼ ì¤„ì´ê³  ê°€ì…ìœ¼ë¡œ í•œë²ˆì— ìœ ë„í•˜ì—¬ ì‚¬ìš©ì ì´íƒˆìœ¨ì„ ì¤„ì¼ ìˆ˜ ìˆë‹¤. ë˜í•œ ë°±ì—”ë“œ ë‹¨ì—ì„œëŠ” ë™ì¼ ì´ë©”ì¼ë¡œ ë™ì‹œ ê°€ì… ì‹œë„í•  ë•Œ ë°œìƒí•˜ëŠ” ì¶©ëŒì„ ë°©ì§€í•  ìˆ˜ ìˆë‹¤. 
    ```
    // ì´ë©”ì¼ ì¤‘ë³µí™•ì¸
     public boolean checkEmailDuplicate(String email) {

        boolean flag = userRepository.existsByEmail(email);
        log.info("email - {} is duplicated: {}", email, flag);

        if(!flag) processSignUp(email);

        return flag;
    }

     // ì¸ì¦ ì½”ë“œ ë°œì†¡ìš© ì„ì‹œ íšŒì›ê°€ì… ë¡œì§
    private void processSignUp(String email) {
        // 1. ì„ì‹œ íšŒì›ê°€ì… ì§„í–‰
        User tempUser = User.builder()
                .email(email)
                .build();

        User savedUser = userRepository.save(tempUser);

        // 2. ì¸ì¦ë©”ì¼ ë°œì†¡
        String code = sendVerificationEmail(email);

        // 3. ì¸ì¦ ì½”ë“œ ìœ ì €, ë§Œë£Œì‹œê°„ì„ ì¸ì¦ í…Œì´ë¸”ì— ì €ì¥
        EmailVerification verification = EmailVerification.builder()
                .user(savedUser)
                .verificationCode(code)
                .expiryDate(LocalDateTime.now().plusMinutes(5))
                .build();

        emailVerificationRepository.save(verification);

    }
    ```
    ì„ì‹œ íšŒì›ê°€ì… ë¡œì§ì„ ì§„í–‰í•˜ê¸° ìœ„í•´ password ë“± í•„ìˆ˜ ì…ë ¥ ê°’ë“¤ì€ Not null ì„¤ì •ì„ í•˜ì§€ ì•ŠëŠ”ë‹¤.    
    -> SNS ë¡œê·¸ì¸í•œ íšŒì›, ì¸ì¦ë²ˆí˜¸ë§Œ ë°›ê³  íšŒì›ê°€ì…ì„ ë§ˆë¬´ë¦¬í•˜ì§€ ì•Šì€ íšŒì›ì´ ìˆì„ ìˆ˜ë„ ìˆë‹¤.
    ![alt text](image-32.png)   
    ì„ì‹œ íšŒì›ê°€ì… ë¡œì§ì´ ë™ì‘í•¨ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

    
